# Enhanced rate limiting per IP
SecAction \
    "id:2000,\
    phase:1,\
    nolog,\
    pass,\
    initcol:ip=%{REMOTE_ADDR},\
    setvar:ip.requests=0,\
    setvar:ip.ts=%{TIME_EPOCH}"

SecRule IP:REQUESTS "@gt 100" \
    "id:2001,\
    phase:1,\
    deny,\
    status:429,\
    log,\
    msg:'Rate limit exceeded',\
    expirevar:ip.requests=60"

# Protect file uploads with strict filtering
SecRule FILES_NAMES "@rx .*" \
    "id:2002,\
    phase:2,\
    block,\
    msg:'Invalid file type',\
    logdata:'%{MATCHED_VAR}',\
    tag:'file-upload',\
    chain"
    SecRule FILES_NAMES "!@rx \.(?:jpg|jpeg|png|gif|webp)$" "t:lowercase"

# Allow specific endpoints with authentication check
SecRule REQUEST_URI "!@beginsWith /api/" \
    "id:1100,\
    phase:1,\
    pass,\
    skip:1,\
    nolog"

SecRule REQUEST_URI "!@rx ^/api/(?:user|auth|pong|chats)(?:/|$)" \
    "id:1101,\
    phase:1,\
    block,\
    log,\
    msg:'Invalid API Path',\
    logdata:'%{REQUEST_URI}',\
    status:403,\
    severity:'CRITICAL'"

SecRule &REQUEST_HEADERS:Authorization "@eq 0" \
    "t:none,\
    deny,\
    status:401,\
    msg:'Authentication required'"