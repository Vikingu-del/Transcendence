# Basic ModSecurity configuration
SecRuleEngine On
SecRequestBodyAccess On
SecResponseBodyAccess On

# Include custom rules
Include /etc/nginx/modsecurity.d/custom-rules/REQUEST-900-GENERIC-ATTACKS.conf
Include /etc/nginx/modsecurity.d/custom-rules/REQUEST-901-CUSTOMIZATION.conf

# Enhanced MIME type protection
SecResponseBodyMimeType text/plain text/html text/xml application/json application/x-www-form-urlencoded multipart/form-data

# Security Headers
SecRule RESPONSE_HEADERS "^(?!X-Frame-Options:|X-XSS-Protection:|X-Content-Type-Options:|Strict-Transport-Security:)" \
    "id:10,\
    phase:3,\
    pass,\
    nolog,\
    setenv:MISSING_SECURITY_HEADERS"

# Enhanced Logging
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLog /var/log/modsec_audit.log
SecAuditLogType Serial
SecAuditLogStorageDir /var/log/modsecurity/audit/
SecAuditLogParts ABCFHZ

# DOS Protection
SecRule IP:REQUEST_COUNTER "@ge 100" \
    "id:20,\
    phase:1,\
    deny,\
    status:429,\
    msg:'Potential DOS Attack Identified',\
    expirevar:IP:REQUEST_COUNTER=60"

# Increase request body limits for file uploads
SecRequestBodyLimit 5242880
SecRequestBodyNoFilesLimit 131072

# File Upload Protection
SecRule FILES_NAMES "@rx .*" \
    "id:30,\
    phase:2,\
    pass,\
    nolog,\
    setvar:'tx.allowed_file_extensions=jpg png jpeg gif webp'"

SecRule FILES "\.([^.]+)$" \
    "chain,\
    id:31,\
    phase:2,\
    block,\
    msg:'Invalid File Type',\
    logdata:'%{MATCHED_VAR}'"
    SecRule TX:/^MATCHED_VAR/ "!@within %{tx.allowed_file_extensions}"

# OWASP CRS Configuration with Paranoia Level
SecAction \
    "id:900000,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:tx.paranoia_level=2,\
    setvar:tx.enforce_bodyproc_urlencoded=1"

# Include OWASP Core Rule Set
Include "/etc/modsecurity.d/owasp-crs/crs-setup.conf"
Include "/etc/modsecurity.d/owasp-crs/rules/*.conf"

# Custom Rules for Enhanced Security
# Protect against path traversal
SecRule REQUEST_URI "@contains ../" \
    "id:40,\
    phase:1,\
    deny,\
    status:403,\
    msg:'Path Traversal Attack Detected'"

# Protect against common web attacks
SecRule REQUEST_HEADERS|ARGS "@pmFromFile /etc/nginx/modsecurity.d/data/attack-signatures.dat" \
    "id:50,\
    phase:2,\
    deny,\
    status:403,\
    msg:'Common Web Attack Pattern Detected'"

# Advanced SQL Injection Protection
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY|REQUEST_HEADERS \
    "@pmFromFile /etc/nginx/modsecurity.d/data/sql-patterns.dat" \
    "id:60,\
    phase:2,\
    deny,\
    status:403,\
    msg:'Advanced SQL Injection Attempt Detected'"

# Rate Limiting with burst allowance
SecAction \
    "id:70,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:ip.requests_per_minute=0,\
    setvar:ip.burst_allowance=10,\
    expirevar:ip.requests_per_minute=60"