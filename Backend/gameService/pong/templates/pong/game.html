<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pong Game</title>
    <style>
        body { text-align: center; font-family: Arial, sans-serif; }
        canvas { background: black; display: block; margin: auto; }
    </style>
</head>
<body data-game-id="{{ game.id }}">
    <h1>Pong Game</h1>
    <canvas id="pongCanvas" width="800" height="400"></canvas>
    <p id="scoreboard"></p>
    <script>
        const canvas = document.getElementById("pongCanvas");
        const ctx = canvas.getContext("2d");

        const player1 = "{{ player1 }}";
        const player2 = "{{ player2 }}";

        // Game objects
        const paddleWidth = 10, paddleHeight = 80;
        let p1 = { x: 10, y: canvas.height / 2 - paddleHeight / 2, score: 0 };
        let p2 = { x: canvas.width - 20, y: canvas.height / 2 - paddleHeight / 2, score: 0 };
        let ball = { x: canvas.width / 2, y: canvas.height / 2, radius: 8, dx: 3, dy: 3 };

        // Controls
        const keys = {};
        document.addEventListener("keydown", (e) => keys[e.key] = true);
        document.addEventListener("keyup", (e) => keys[e.key] = false);

        function movePaddles() {
            if (keys["w"] && p1.y > 0) p1.y -= 5;
            if (keys["s"] && p1.y < canvas.height - paddleHeight) p1.y += 5;
            if (keys["ArrowUp"] && p2.y > 0) p2.y -= 5;
            if (keys["ArrowDown"] && p2.y < canvas.height - paddleHeight) p2.y += 5;
        }

        function moveBall() {
        ball.x += ball.dx;
        ball.y += ball.dy;

        // Bounce off top/bottom
        if (ball.y <= 0 || ball.y >= canvas.height) ball.dy *= -1;

        // Paddle collision
        if (
            (ball.x - ball.radius <= p1.x + paddleWidth && ball.y >= p1.y && ball.y <= p1.y + paddleHeight) ||
            (ball.x + ball.radius >= p2.x && ball.y >= p2.y && ball.y <= p2.y + paddleHeight)
        ) {
            ball.dx *= -1;
        }

        // Score update
        if (ball.x <= 0) { 
            p2.score++; 
            checkGameOver(); 
            resetBall(); 
        }
        if (ball.x >= canvas.width) { 
            p1.score++; 
            checkGameOver(); 
            resetBall(); 
        }

        updateScoreboard();
        }

        let gameOver = false;  // Add a flag to track game state

        // function checkGameOver() { //works perfect
        //     if (p1.score >= 5 || p2.score >= 5) {
        //         gameOver = true;  // Set flag to true so gameLoop stops
        //         let winner = p1.score > p2.score ? player1 : player2;
        //         alert(`The winner is : ${winner} ðŸŽ‰`);

        //         // Show "Start New Game" button
        //         document.getElementById("new-game-btn").style.display = "block";

        //         // Send scores to backend and mark game as inactive
        //         fetch(window.location.pathname + "save/", {
        //             method: "POST",
        //             headers: {
        //                 "Content-Type": "application/json",
        //                 "X-CSRFToken": "{{ csrf_token }}"
        //             },
        //             body: JSON.stringify({
        //                 player1_score: p1.score,
        //                 player2_score: p2.score
        //             })
        //         }).then(response => response.json())
        //         .then(data => console.log("Match result saved!", data))
        //         .catch(error => console.error("Error:", error));
        //     }
        // }
        
        function checkGameOver() {
            if (p1.score >= 5 || p2.score >= 5) {
                gameOver = true;  // Stop the game loop
                
                // Force score update before showing the alert
                updateScoreboard();
                
                setTimeout(() => { 
                    let winner = p1.score > p2.score ? player1 : player2;
                    alert(`The winner is : ${winner} ðŸŽ‰`);

                    // Show "Start New Game" button
                    document.getElementById("new-game-btn").style.display = "block";

                    // Send scores to backend and mark game as inactive
                    fetch(window.location.pathname + "save/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}"
                        },
                        body: JSON.stringify({
                            player1_score: p1.score,
                            player2_score: p2.score
                        })
                    }).then(response => response.json())
                    .then(data => console.log("Match result saved!", data))
                    .catch(error => console.error("Error:", error));
                }, 100);  // Small delay to ensure score is updated visually before the alert appears
            }
        }

 
        function resetBall() {
            ball.x = canvas.width / 2;
            ball.y = canvas.height / 2;
            ball.dx = 3 * (Math.random() > 0.5 ? 1 : -1);
            ball.dy = 3 * (Math.random() > 0.5 ? 1 : -1);
        }

        function updateScoreboard() {
            document.getElementById("scoreboard").innerText = `${player1}: ${p1.score} | ${player2}: ${p2.score}`;
        }

        function gameLoop() {
            if (gameOver) return; // Stop the loop if the game is over

            movePaddles();
            moveBall();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "white";

            // Draw paddles
            ctx.fillRect(p1.x, p1.y, paddleWidth, paddleHeight);
            ctx.fillRect(p2.x, p2.y, paddleWidth, paddleHeight);

            // Draw ball
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            ctx.fill();

            requestAnimationFrame(gameLoop);
        }


        gameLoop();

        function restartGame() {
            const gameId = document.body.getAttribute("data-game-id");  // Get the current game ID

            fetch(`/pong/start-new-game/${gameId}/`, {  
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.new_game_url) {
                    window.location.href = data.new_game_url;  // Redirect to new game with new ID
                }
            })
            .catch(error => console.error("Error starting new game:", error));
        }





    </script>
    <button id="new-game-btn" style="display: none;" onclick="restartGame()">Start New Game</button>
    <p><p><p></p></p></p>
    <h2>Past Match History</h2>
</body>
</html>
